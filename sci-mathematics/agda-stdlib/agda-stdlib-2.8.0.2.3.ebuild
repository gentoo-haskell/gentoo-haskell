# Copyright 1999-2025 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

EAPI=8

# ebuild generated by hackport 0.9.1.0.9999

CABAL_FEATURES="profile"
inherit haskell-cabal

## shared with sci-mathematics/agda
# upstream does not maintain version ordering:
#  https://github.com/agda/agda-stdlib/releases
# 0.11 -> 2.5.0.20160213 -> 2.5.0.20160412 -> 0.12 -> 0.13
# As Agda-stdlib is tied to Agda version we encode
# both versions in gentoo version.
##
MY_UPSTREAM_AGDA_STDLIB_V="2.3"
MY_GENTOO_AGDA_STDLIB_V="${PV}.${MY_UPSTREAM_AGDA_STDLIB_V}"
MY_UPSTREAM_AGDA_V="${PV%.${MY_UPSTREAM_AGDA_STDLIB_V}}"

DESCRIPTION="Agda standard library"
HOMEPAGE="https://wiki.portal.chalmers.se/agda/"
SRC_URI="https://github.com/agda/${PN}/archive/v${MY_UPSTREAM_AGDA_STDLIB_V}.tar.gz -> ${P}.tar.gz"

S=${WORKDIR}/${PN}-${MY_UPSTREAM_AGDA_STDLIB_V}
CABAL_FILE="${S}/${PN}-utils.cabal"

LICENSE="MIT"
SLOT="0"
KEYWORDS="~amd64"

RDEPEND="
	>=sci-mathematics/agda-${MY_UPSTREAM_AGDA_V}:=[profile?]
	>=dev-haskell/filemanip-0.3.6.2:= <dev-haskell/filemanip-0.4:=
	>=dev-haskell/text-1.2.3.1:= <dev-haskell/text-2.2:=
	>=dev-lang/ghc-9.0.2:=
"
DEPEND="${RDEPEND}
	>=dev-haskell/cabal-3.4.1.0
"

src_compile() {
	haskell-cabal_src_compile
	"${S}"/dist/build/GenerateEverything/GenerateEverything \
		|| die "GenerateEverything failed"
	local prof
	use profile && prof="--ghc-flag=-prof"
	agda +RTS -K1G -RTS ${prof} \
		-i "${S}" -i "${S}"/src "${S}"/Everything.agda || die
	# Although my agda-9999 build has
	# /var/tmp/portage/sci-mathematics/agda-9999/work/agda-9999/dist/build/autogen/Paths_Agda.hs
	# containing:
	# datadir    = "/usr/share/agda-9999/ghc-7.6.1"
	# it fails without the --css option like:
	# /usr/share/agda-9999/ghc-7.4.1/Agda.css: copyFile: does not exist
	local paths="${S}/dist/build/GenerateEverything/autogen/Paths_agda_stdlib_utils.hs"
	local cssdir=$(egrep 'datadir *=' "${paths}" | sed -e 's@datadir    = \(.*\)@\1@')
	cd "${S}"/doc
	agda --html -i "${S}" -i "${S}"/src --css="${cssdir}/Agda.css" README.agda || die
}

src_test() {
	cd "${S}"/doc
	agda -i "${S}" -i "${S}"/src README.agda || die
}

src_install() {
	insinto usr/share/agda-stdlib
	insopts --preserve-timestamps
	doins -r src/*
	dodoc -r doc/html/*
	doins "${FILESDIR}/standard-library.agda-lib"
	mkdir -p usr/share/agda-stdlib/_build/${MY_UPSTREAM_AGDA_V}/agda
	insinto  usr/share/agda-stdlib/_build/${MY_UPSTREAM_AGDA_V}/agda
	doins -r _build/${MY_UPSTREAM_AGDA_V}/agda/src/*
}
